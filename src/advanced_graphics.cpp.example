#include <TFT_eSPI.h>
#include <SPI.h>

TFT_eSPI tft = TFT_eSPI();

void demoShapes()
{
    tft.fillScreen(TFT_BLACK);

    tft.setTextColor(TFT_WHITE, TFT_BLACK);
    tft.setTextFont(2);
    tft.setCursor(5, 5);
    tft.println("Advanced Shapes:");

    // Draw various shapes
    tft.drawRoundRect(10, 30, 60, 40, 8, TFT_CYAN);
    tft.fillRoundRect(80, 30, 60, 40, 8, TFT_MAGENTA);

    // Draw triangles
    tft.drawTriangle(160, 30, 180, 70, 200, 30, TFT_YELLOW);
    tft.fillTriangle(210, 30, 230, 70, 235, 30, TFT_GREEN);

    // Draw ellipse approximation using circles
    for (int i = 0; i < 20; i++)
    {
        float angle = i * 18 * PI / 180;
        int x = 60 + 40 * cos(angle);
        int y = 100 + 15 * sin(angle);
        tft.drawPixel(x, y, TFT_RED);
    }
}

void demoGradients()
{
    tft.fillScreen(TFT_BLACK);

    tft.setTextColor(TFT_WHITE, TFT_BLACK);
    tft.setTextFont(2);
    tft.setCursor(5, 5);
    tft.println("Gradients:");

    // Horizontal gradient
    for (int x = 0; x < 240; x++)
    {
        uint8_t red = map(x, 0, 239, 0, 255);
        uint16_t color = tft.color565(red, 0, 255 - red);
        tft.drawFastVLine(x, 30, 20, color);
    }

    // Vertical gradient
    for (int y = 0; y < 50; y++)
    {
        uint8_t green = map(y, 0, 49, 0, 255);
        uint16_t color = tft.color565(0, green, 255 - green);
        tft.drawFastHLine(20, 60 + y, 200, color);
    }

    // Radial gradient effect
    int centerX = 120, centerY = 90;
    for (int r = 0; r < 30; r++)
    {
        uint8_t intensity = map(r, 0, 29, 255, 0);
        uint16_t color = tft.color565(intensity, intensity / 2, intensity / 4);
        tft.drawCircle(centerX, centerY, r, color);
    }
}

void draw3DCube(int centerX, int centerY, int size, float rotation)
{
    // 3D cube vertices
    float vertices[8][3] = {
        {-1, -1, -1}, {1, -1, -1}, {1, 1, -1}, {-1, 1, -1}, {-1, -1, 1}, {1, -1, 1}, {1, 1, 1}, {-1, 1, 1}};

    // Rotate and project vertices
    int projected[8][2];
    for (int i = 0; i < 8; i++)
    {
        // Simple rotation around Y axis
        float x = vertices[i][0] * cos(rotation) - vertices[i][2] * sin(rotation);
        float y = vertices[i][1];
        float z = vertices[i][0] * sin(rotation) + vertices[i][2] * cos(rotation);

        // Simple perspective projection
        float scale = size / (3 + z);
        projected[i][0] = centerX + x * scale;
        projected[i][1] = centerY + y * scale;
    }

    // Draw cube edges
    int edges[12][2] = {
        {0, 1}, {1, 2}, {2, 3}, {3, 0}, // back face
        {4, 5},
        {5, 6},
        {6, 7},
        {7, 4}, // front face
        {0, 4},
        {1, 5},
        {2, 6},
        {3, 7} // connecting edges
    };

    for (int i = 0; i < 12; i++)
    {
        int v1 = edges[i][0], v2 = edges[i][1];
        tft.drawLine(projected[v1][0], projected[v1][1],
                     projected[v2][0], projected[v2][1], TFT_GREEN);
    }
}

void demo3DEffect()
{
    tft.fillScreen(TFT_BLACK);

    tft.setTextColor(TFT_WHITE, TFT_BLACK);
    tft.setTextFont(2);
    tft.setCursor(5, 5);
    tft.println("3D Effects:");

    // Draw a 3D cube wireframe
    draw3DCube(120, 70, 30, millis() * 0.001);

    // Draw perspective lines
    int vanishX = 200, vanishY = 40;
    for (int i = 0; i < 8; i++)
    {
        int startX = 10 + i * 25;
        int startY = 120;
        tft.drawLine(startX, startY, vanishX, vanishY, TFT_CYAN);
    }
}

void demoParticles()
{
    tft.fillScreen(TFT_BLACK);

    tft.setTextColor(TFT_WHITE, TFT_BLACK);
    tft.setTextFont(2);
    tft.setCursor(5, 5);
    tft.println("Particle System:");

    // Simple particle system
    struct Particle
    {
        float x, y, vx, vy;
        uint16_t color;
        int life;
    };

    static Particle particles[20];
    static bool initialized = false;

    if (!initialized)
    {
        for (int i = 0; i < 20; i++)
        {
            particles[i].x = 120;
            particles[i].y = 67;
            particles[i].vx = random(-30, 30) / 10.0;
            particles[i].vy = random(-30, 30) / 10.0;
            particles[i].color = tft.color565(random(255), random(255), random(255));
            particles[i].life = random(50, 150);
        }
        initialized = true;
    }

    // Clear previous frame
    tft.fillRect(0, 30, 240, 105, TFT_BLACK);

    // Update and draw particles
    for (int i = 0; i < 20; i++)
    {
        if (particles[i].life > 0)
        {
            // Update position
            particles[i].x += particles[i].vx;
            particles[i].y += particles[i].vy;
            particles[i].vy += 0.1; // gravity
            particles[i].life--;

            // Draw particle
            tft.drawPixel(particles[i].x, particles[i].y, particles[i].color);

            // Reset if dead
            if (particles[i].life <= 0)
            {
                particles[i].x = 120;
                particles[i].y = 67;
                particles[i].vx = random(-30, 30) / 10.0;
                particles[i].vy = random(-30, 30) / 10.0;
                particles[i].color = tft.color565(random(255), random(255), random(255));
                particles[i].life = random(50, 150);
            }
        }
    }
}

void setup()
{
    Serial.begin(115200);

    tft.init();
    tft.setRotation(1);
    tft.fillScreen(TFT_BLACK);

    // Turn on backlight
    pinMode(4, OUTPUT);
    digitalWrite(4, HIGH);

    Serial.println("Advanced Graphics Demo Starting...");
}

void loop()
{
    // Demo various graphics capabilities
    demoShapes();
    delay(3000);

    demoGradients();
    delay(3000);

    demo3DEffect();
    delay(3000);

    demoParticles();
    delay(3000);
}